

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1. Overview &mdash; OmniSciDB  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2. Data Flow" href="flow.html" />
    <link rel="prev" title="6. Data Types" href="../data_model/types.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OmniSciDB
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">High Level Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">1. OmniSciDB at 30,000 feet</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Model</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_model/catalog/index.html">1. Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_model/columnar_layout.html">2. Columnar Data Organization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_model/physical_layout.html">3. Physical Data Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_model/memory_layout.html">4. Memory  Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_model/api.html">5. External API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_model/types.html">6. Data Types</a></li>
</ul>
<p class="caption"><span class="caption-text">Query Execution</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#architecture">1.1. Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#high-level-services">1.2. High-Level Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#request-handler-mapdhandler">1.2.1. Request Handler (MapDHandler)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#calcite-service">1.2.2. Calcite Service</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#executing-relational-algebra">1.3. Executing Relational Algebra</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#relational-algebra-interpreter">1.3.1. Relational Algebra Interpreter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#relational-algebra-optimizer">1.3.2. Relational Algebra Optimizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#work-unit-executor">1.3.3. Work Unit Executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#execution-dispatcher">1.3.4. Execution Dispatcher</a></li>
<li class="toctree-l3"><a class="reference internal" href="#native-code-generator">1.3.5. Native Code Generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#native-code-executor">1.3.6. Native Code Executor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="flow.html">2. Data Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="parse.html">3. Parser / Planner</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimization.html">4. Interpreter / Optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheduler.html">5. Scheduler / DAG Executor</a></li>
<li class="toctree-l1"><a class="reference internal" href="codegen.html">6. Code Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="kernels.html">7. Execution Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="results.html">8. Query Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows.html">9. Example Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/logger.html">1. Logger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/query_state.html">2. QueryState</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OmniSciDB</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>1. Overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/execution/overview.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="overview">
<h1>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h1>
<p>Here, we describe the various components that make up OmniSciDB’s
Query Execution engine. Examples of typical query execution workflows
are provided in order to illustrate component roles and interactions.</p>
<div class="section" id="architecture">
<h2>1.1. Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../_images/QueryEngine6.png"><img alt="image0" src="../_images/QueryEngine6.png" style="width: 928px;" /></a></p>
</div>
<div class="section" id="high-level-services">
<h2>1.2. High-Level Services<a class="headerlink" href="#high-level-services" title="Permalink to this headline">¶</a></h2>
<div class="section" id="request-handler-mapdhandler">
<h3>1.2.1. Request Handler (MapDHandler)<a class="headerlink" href="#request-handler-mapdhandler" title="Permalink to this headline">¶</a></h3>
<p>The <code class="code docutils literal notranslate"><span class="pre">MapDHandler</span></code> class is responsible for executing business logic for
all requests handled by the OmniSci DB server. There are a number of
endpoints provided by the <code class="code docutils literal notranslate"><span class="pre">MapDHandler</span></code> class used to communicate
which can be used to communicate with the <cite>OmniSciDB</cite> Server.</p>
<p>The <code class="code docutils literal notranslate"><span class="pre">MapDHandler::sql_execute()</span></code> is the endpoint through which queries
are executed. This endpoint orchestrates the query from start to finish,
and returns a <code class="code docutils literal notranslate"><span class="pre">TResultSet</span></code> to the Thrift caller.</p>
</div>
<div class="section" id="calcite-service">
<h3>1.2.2. Calcite Service<a class="headerlink" href="#calcite-service" title="Permalink to this headline">¶</a></h3>
<p>The Calcite service provides a Thrift API that enables transformation of raw
SQL query statements/strings to <a class="reference external" href="https://calcite.apache.org/docs/algebra.html">relational algebra
expressions</a> in JSON
format. A relational algebra expression can be considered a form of the
SQL query that has been broken down into simple discrete steps.
See the <a class="reference internal" href="workflows.html"><span class="doc">Workflows</span></a> section for examples of how
the relational algebra output looks under various use-cases.</p>
<p>The Calcite service is run as a child process of the OmniSci DB server.
Calcite server management and API access business logic can be
found in <code class="code docutils literal notranslate"><span class="pre">Calcite.cpp</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Calcite is used only for DDL statements. For DML statements,
a Bison-based parser is used.</p>
</div>
</div>
</div>
<div class="section" id="executing-relational-algebra">
<h2>1.3. Executing Relational Algebra<a class="headerlink" href="#executing-relational-algebra" title="Permalink to this headline">¶</a></h2>
<p>The Relational Algebra Executor provides a second layer of orchestration for
executing the resulting relational algebra expression received from the
Calcite service.</p>
<p>This component converts Calcite’s relational algebra nodes
to an optimized internal representation, represented by <code class="code docutils literal notranslate"><span class="pre">RelAlgNode</span></code>
and it’s derivatives.</p>
<p>The Relational Algebra Executor creates “work units” for
each relational algebra node and delegates
execution of these work units to the work unit executor.
Work unit creation also involves creation of “analyzer
expressions” objects from relational algebra nodes.</p>
<p>Prior to execution, the code generator component transforms
analyzer expression objects, then compiles them into executable
device code using <cite>LLVM</cite>.</p>
<p>After execution, a <code class="code docutils literal notranslate"><span class="pre">ResultSet</span></code> is sent back to the
request handler (<code class="code docutils literal notranslate"><span class="pre">MapDHandler</span></code>) and ultimately returned to
the Thrift client.</p>
<p>The intermediary steps involved in Relational Algebra execution
are described below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Relational Algebra executor handles execution hand-off
from CPU to GPU when a downstream layer throws a
<code class="code docutils literal notranslate"><span class="pre">QueryMustRunOnCpu</span></code> exception.</p>
</div>
<div class="section" id="relational-algebra-interpreter">
<h3>1.3.1. Relational Algebra Interpreter<a class="headerlink" href="#relational-algebra-interpreter" title="Permalink to this headline">¶</a></h3>
<p>The Relational Algebra Interpreter converts relational algebra expressions
provided by Calcite’s JSON format to an internal
representation referred to as relational algebra nodes (in code, these
are sub-classes of the <code class="code docutils literal notranslate"><span class="pre">RelAlgNode</span></code> class).
The interpreter then performs optimizations on the generated relational
algebra nodes using the relational algebra optimizer.</p>
</div>
<div class="section" id="relational-algebra-optimizer">
<h3>1.3.2. Relational Algebra Optimizer<a class="headerlink" href="#relational-algebra-optimizer" title="Permalink to this headline">¶</a></h3>
<p>Relational algebra optimizer, as the name implies, performs optimization
on relational algebra nodes. These optimizations entail identifying and
marking no op nodes, eliminating duplicate nodes, combining multiple
nodes into compound nodes, pruning unused columns, etc.</p>
</div>
<div class="section" id="work-unit-executor">
<h3>1.3.3. Work Unit Executor<a class="headerlink" href="#work-unit-executor" title="Permalink to this headline">¶</a></h3>
<p>The work unit executor is the component (implemented by the <em>Executor</em>
class) that is responsible for executing work units created by the
relational algebra executor. In order to execute a work unit, this
component creates an <code class="code docutils literal notranslate"><span class="pre">execution</span> <span class="pre">dispatch</span></code> object, which abstracts
generation of compiled code for the work unit,
spins off a thread for each fragment involved in query execution,
executes generated code against appropriate fragments (and chunks/column
buffers)
and gathers the results from each thread execution and device (e.g
CPU/GPU) into one result set.</p>
</div>
<div class="section" id="execution-dispatcher">
<h3>1.3.4. Execution Dispatcher<a class="headerlink" href="#execution-dispatcher" title="Permalink to this headline">¶</a></h3>
<p>Execution dispatcher encapsulates compilation/generation of code for a
given work unit and execution/running of the generated code. Work unit
code generation/compilation is managed by the CodeGenerator with native code generation handled by the Executor. Running/execution of generated code is implemented by
the executor. This component is implemented by the
<code class="code docutils literal notranslate"><span class="pre">Executor::ExecutionDispatch</span></code> class.</p>
</div>
<div class="section" id="native-code-generator">
<h3>1.3.5. Native Code Generator<a class="headerlink" href="#native-code-generator" title="Permalink to this headline">¶</a></h3>
<p>Native code generator is the component that is responsible for
generating code that corresponds to a work unit. Native code generator
uses LLVM C++ libraries to build logical code blocks (that are mainly
based on analyzer expressions contained within the work unit) and
generate an intermediate representation (LLVM IR) of the code. The
intermediate representation may be different for CPU vs GPU depending on
the use case. For CUDA GPU use cases, the LLVM IR intermediate
representation is converted to another intermediate representation
called
<a class="reference external" href="https://docs.nvidia.com/cuda/parallel-thread-execution/index.html">PTX</a>,
which is then converted to an executable.
Native code generator also performs optimizations on the LLVM IR in
order to ensure minimal memory footprint and better performance for
generated executable. The output of the code generator is a function
pointer to the entry function that executes generated query execution
code.</p>
</div>
<div class="section" id="native-code-executor">
<h3>1.3.6. Native Code Executor<a class="headerlink" href="#native-code-executor" title="Permalink to this headline">¶</a></h3>
<p>Native code executor fetches chunks for relevant columns for the query
and stores the chunk data in a buffer that is passed as a parameter to
the query execution function (created by native code generator), which
is then invoked. Native code executor component, in code, is not
actually a self-contained component but a combination of code in
<code class="code docutils literal notranslate"><span class="pre">ExecutionDispatch</span></code> and <code class="code docutils literal notranslate"><span class="pre">QueryExecutionContext</span></code>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="flow.html" class="btn btn-neutral float-right" title="2. Data Flow" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../data_model/types.html" class="btn btn-neutral float-left" title="6. Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, OmniSci, Inc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>